---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";

// 1. ç”Ÿæˆæ‰€æœ‰æ–‡ç« çš„é™æ€è·¯å¾„
export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// 2. æ ¸å¿ƒé»‘ç§‘æŠ€ï¼šä¸‡èƒ½å›¾ç‰‡è§£æå™¨ (å…¼å®¹æ—§å¯¹è±¡æ ¼å¼ä¸æ–°å­—ç¬¦ä¸² ID)
const resolveImg = (imgData) => {
  if (!imgData) return "";
  
  // A. å¦‚æœæ˜¯æ—§çš„å¯¹è±¡æ ¼å¼ {src: "...", alt: "..."}ï¼Œæå– src å­—ç¬¦ä¸²
  let rawUrl = typeof imgData === 'object' ? imgData.src : imgData;
  
  // B. å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„ HTTP é“¾æ¥ï¼Œç›´æ¥è¿”å›
  if (rawUrl.startsWith("http")) return rawUrl;
  
  // C. å¦‚æœæ˜¯çº¯ ID (å¦‚ photo-xxx)ï¼Œæ‰§è¡Œåå…­è¿›åˆ¶æ‹¼æ¥å¤§æ³•
  const p1 = "https://images.unsplash.com" + "\x2f";
  return `${p1}${rawUrl}?auto=format&fit=crop&w=1200&q=80`;
};

// 3. åˆ¤æ–­æ˜¯å¦å±äº Market åˆ†ç±»ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´è¿”å›æŒ‰é’®
const isMarket = entry.data.category === "Market";
---

<Layout title={entry.data.title}>
  <Container>
    <div class="mx-auto max-w-3xl mt-14">
      <!-- ç»Ÿä¸€ä½¿ç”¨ç¿¡ç¿ ç»¿å“ç‰Œè‰² -->
      <span class="text-emerald-600 uppercase tracking-wider text-sm font-bold">
        {entry.data.category}
      </span>
      <h1
        class="text-4xl lg:text-5xl font-bold lg:tracking-tight mt-1 lg:leading-tight text-slate-800">
        {entry.data.title}
      </h1>
      <div class="flex gap-2 mt-3 items-center flex-wrap md:flex-nowrap">
        <span class="text-slate-400">
          {entry.data.author}
        </span>
        <span class="text-slate-400">â€¢</span>
        <time
          class="text-slate-400"
          datetime={entry.data.publishDate.toISOString()}>
          {entry.data.publishDate.toDateString()}
        </time>
        <span class="text-slate-400 hidden md:block">â€¢</span>
        <div class="w-full md:w-auto flex flex-wrap gap-3">
          {
            entry.data.tags.map((tag) => (
              <span class="text-sm text-slate-500">#{tag}</span>
            ))
          }
        </div>
      </div>
    </div>

    <!-- æ–‡ç« é¡¶éƒ¨å¤§å›¾ï¼šä½¿ç”¨ä¸‡èƒ½è§£æå™¨ï¼Œç¡®ä¿å›¾ç‰‡æ— è®ºæ–°æ—§æ ¼å¼éƒ½èƒ½äº®èµ·æ¥ -->
    <div class="mx-auto max-w-3xl mt-8 overflow-hidden rounded-xl bg-slate-50 shadow-sm">
       <img 
         src={resolveImg(entry.data.image)} 
         alt={entry.data.title}
         class="w-full object-cover aspect-video" 
       />
    </div>

    <!-- æ–‡ç« æ­£æ–‡å†…å®¹ -->
    <div class="mx-auto prose prose-lg mt-6 max-w-3xl prose-headings:text-slate-800 prose-p:text-slate-600">
      <Content />
    </div>

    <!-- ğŸ’¡ è¿”å›é€»è¾‘é—­ç¯ï¼šæ ¹æ®åˆ†ç±»åŠ¨æ€æ”¹å˜è¿”å›è·¯å¾„ä¸æ–‡æ¡ˆ -->
    <div class="text-center mt-12 pb-20 border-t border-slate-100 pt-10">
      <a
        href={isMarket ? "/market" : "/blog"}
        class="bg-emerald-50 text-emerald-700 px-8 py-3 rounded-md hover:bg-emerald-100 transition font-medium inline-flex items-center gap-2"
      >
        {isMarket ? "â† Back to Market Intelligence" : "â† Back to Blog"}
      </a>
    </div>
  </Container>
</Layout>
